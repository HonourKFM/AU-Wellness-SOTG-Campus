<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AU Wellness Watch - CSSTHE</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- AU Blue Theme Color -->
    <meta name="theme-color" content="#004a99">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AU Wellness">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <!-- TailwindCSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'au-blue': '#004a99',
              'au-blue-dark': '#003366',
            }
          }
        }
      }
    </script>

<!-- Importmap for external libraries -->
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0"
  }
}
</script>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- 
      START OF CONSOLIDATED APPLICATION SCRIPT
      This script contains the entire React application, with all fixes integrated.
    -->
    <script type="module">
// --- GATHERED EXTERNAL IMPORTS ---
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import ReactDOM from 'react-dom/client';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

// --- START OF types.ts ---
/**
 * Formats a raw counselor ID (e.g., 1, "12") into the "PCXX" format.
 */
const formatCounselorId = (id) => {
  if (typeof id === 'string' && id.startsWith('PC')) {
    return id;
  }
  const numericId = parseInt(String(id), 10);
  if (isNaN(numericId)) {
    return String(id);
  }
  return `PC${String(numericId).padStart(2, '0')}`;
};

// --- START OF constants.ts ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwUM5nsCEoKDJMqmt_hlpeYX1DzBPY6WPC5XfOsN-57O5hBSdAH8710oT2C9GKW1VdL/exec';
const ADMIN_PASSWORD = 'admin@sotg.pilot.fynex';

const CONCERN_CATEGORIES = [
  "Academic Stress (Exams, Assignments)",
  "Financial Stress (Fees, Upkeep)",
  "Relationship Issues (Peers, Partners)",
  "Family Problems",
  "Social & Belonging (Exclusion, Bullying)",
  "Health & Wellness (Physical, Anxiety)",
  "Spiritual Concerns",
  "Other",
  "Thoughts of self-harm",
];

const SUICIDE_STAGES = [
  "Ideation (Thoughts)",
  "Para-suicide (Non-lethal attempt)",
  "Attempted",
  "Non-suicidal Self-Injury",
  "Other (Requires follow-up)",
];

const CAMPUS_LOCATIONS = [
  "Student Union (SU)",
  "Dining Hall (DH)",
  "Sports Fields / Gym",
  "Main Campus Hostels",
  "New Hostels (F-Blocks)",
  "Library (JWM Library)",
  "Clinic",
  "Chapel",
  "Other/Off-Campus",
];

const COLLEGES = [
  "CSSTHE",
  "CBPLG",
  "CHANS",
  "School of Law",
];

const GENDERS = ["Male", "Female", "Other", "Unknown / Not Specified"];

const YEAR_OF_STUDY = [
  "First Year",
  "Second Year",
  "Third Year",
  "Fourth Year",
  "Post-Grad",
  "Unknown",
];

const MARITAL_STATUSES = [
  "Single",
  "In a relationship",
  "Married",
  "Other",
  "Unknown",
];

// --- START OF hooks/useLocalStorage.ts ---
function getValueFromStorage(key, initialValue) {
  try {
    const item = window.localStorage.getItem(key);
    return item ? JSON.parse(item) : initialValue;
  } catch (error) {
    console.error(`Error reading localStorage key "${key}":`, error);
    return initialValue;
  }
}

function useLocalStorage(key, initialValue) {
  const [storedValue, setStoredValue] = useState(() => getValueFromStorage(key, initialValue));

  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(storedValue));
    } catch (error) {
      console.error(`Error setting localStorage key "${key}":`, error);
    }
  }, [key, storedValue]);

  return [storedValue, setStoredValue];
}

// --- START OF services/geminiService.ts ---

const GEMINI_API_KEY = ""; // Environment will populate this
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

const generateInsights = async (data) => {
  if (data.length === 0) {
    return "Not enough data to generate insights. Please add more student entries.";
  }

  // Anonymize and simplify data for the prompt
  const simplifiedData = data.map(({ client_id, counselor, name, timestamp, ...rest }) => rest); // Remove PII

  const userQuery = `
    Analyze the following anonymous student concern data.
    Here is the data in JSON format:
    ${JSON.stringify(simplifiedData, null, 2)}
  `;
  
  const systemPrompt = `
    You are a data analyst for a university mental health support service called "AU Wellness Watch".
    Analyze the provided student concern data and provide key insights.
    Structure your response in markdown format with clear headings.

    Focus on these areas:
    1.  **Top 3 Most Common Concerns**: Identify and list the three most frequent primary concern categories among students.
    2.  **Key Demographic Trends**: Summarize trends related to age, gender, and year of study.
    3.  **Location Hotspots**: Briefly describe which campus locations are most frequently cited.
    4.  **Potential Correlations**: Mention any notable patterns or potential correlations.
    5.  **Actionable Suggestion**: Based on the data, provide one actionable suggestion.
  `;
  
  const payload = {
    contents: [{ parts: [{ text: userQuery }] }],
    systemInstruction: {
        parts: [{ text: systemPrompt }]
    },
  };

  try {
    let response;
    let delay = 1000;
    for (let i = 0; i < 3; i++) {
      response = await fetch(GEMINI_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
      });
      if (response.ok) break;
      if (response.status === 429 || response.status >= 500) {
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      } else {
        throw new Error(`API request failed with status ${response.status}`);
      }
    }

    if (!response.ok) {
        throw new Error(`API request failed after retries with status ${response.status}`);
    }

    const result = await response.json();
    const candidate = result.candidates?.[0];

    if (candidate && candidate.content?.parts?.[0]?.text) {
      return candidate.content.parts[0].text;
    } else {
      console.error("Invalid response structure from API:", result);
      throw new Error("Invalid response structure from API.");
    }
  } catch (error) {
    console.error("Error generating insights from Gemini API:", error);
    return "An error occurred while generating AI insights. Please check the console for details.";
  }
};

// --- WHATSAPP SERVICE REMOVED FROM FRONTEND ---
// This is now handled by the code.gs backend.


// --- START OF components/StatCard.tsx ---
const StatCard = ({ label, value, color = '#004a99', size = 'normal' }) => {
  return (
    React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-6 border-l-4", style: { borderColor: color } },
      React.createElement('p', { className: "text-sm font-medium text-gray-500 mb-1" }, label),
      React.createElement('p', { className: `font-bold text-gray-800 ${size === 'large' ? 'text-5xl' : 'text-4xl'}` }, value)
    )
  );
};


// --- START OF components/Header.tsx ---
const SyncStatus = ({ isOnline, syncing, queueLength, isLoadingData }) => {
  if (!isOnline) {
    return (
      React.createElement('div', { className: "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-600" },
        React.createElement('div', { className: "w-2.5 h-2.5 rounded-full bg-gray-500" }),
        React.createElement('span', null, `Offline (${queueLength})`)
      )
    );
  }

  if (isLoadingData) {
    return (
      React.createElement('div', { className: "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700" },
        React.createElement('div', { className: "w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse" }),
        React.createElement('span', null, "Loading Data...")
      )
    );
  }

  if (syncing && queueLength > 0) {
    return (
      React.createElement('div', { className: "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700" },
        React.createElement('div', { className: "w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse" }),
        React.createElement('span', null, `Syncing ${queueLength}...`)
      )
    );
  }

  if (queueLength > 0) {
    return (
      React.createElement('div', { className: "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700" },
        React.createElement('div', { className: "w-2.5 h-2.5 rounded-full bg-yellow-500" }),
        React.createElement('span', null, `${queueLength} to sync`)
      )
    );
  }

  return (
    React.createElement('div', { className: "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700" },
      React.createElement('div', { className: "w-2.5 h-2.5 rounded-full bg-green-500" }),
      React.createElement('span', null, "Online & Synced")
    )
  );
};

const Header = ({ counselor, onLogout, isOnline, syncing, queueLength, currentPage, onNavigate, onAdminClick, isLoadingData }) => {
  return (
    React.createElement('header', { className: "bg-white shadow-md sticky top-0 z-50" },
      React.createElement('div', { className: "container mx-auto px-4 sm:px-6 lg:px-8" },
        React.createElement('div', { className: "flex items-center justify-between h-20" },
          React.createElement('div', { className: "flex items-center gap-3" },
            React.createElement('div', { className: "flex-shrink-0 bg-au-blue w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-xl" }, "AU"),
            React.createElement('div', null,
              React.createElement('h1', { className: "text-xl font-bold text-gray-900" }, "AU Wellness Watch"),
              React.createElement('p', { className: "text-xs text-gray-500" }, "CSSTHE Hackathon Project")
            )
          ),
          React.createElement('div', { className: "hidden md:flex items-center gap-4" },
            React.createElement('button', { onClick: () => onNavigate('counselor'), className: `px-4 py-2 text-sm font-semibold rounded-full transition-colors ${currentPage === 'counselor' ? 'bg-au-blue text-white' : 'text-gray-600 hover:bg-gray-100'}` }, "Counselor Portal"),
            React.createElement('button', { onClick: onAdminClick, className: `px-4 py-2 text-sm font-semibold rounded-full transition-colors ${currentPage === 'dashboard' ? 'bg-au-blue text-white' : 'text-gray-600 hover:bg-gray-100'}` }, "Admin Dashboard")
          ),
          React.createElement('div', { className: "flex items-center gap-4" },
             React.createElement(SyncStatus, { isOnline, syncing, queueLength, isLoadingData }),
            React.createElement('div', { className: "text-right" },
              React.createElement('span', { className: "text-sm font-medium text-gray-700" }, `Welcome, ${counselor.name}`),
              React.createElement('button', { onClick: onLogout, className: "text-xs text-gray-500 hover:text-au-blue transition-colors ml-2" }, "(Logout)")
            )
          )
        )
      )
    )
  );
};

// --- START OF components/CounselorSetup.tsx ---
const CounselorSetup = ({ approvedCounselors, onLogin, onSignupSuccess }) => {
  const [isLoginView, setIsLoginView] = useState(true);
  const [counselorId, setCounselorId] = useState('');
  const [counselorName, setCounselorName] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [signupSuccessInfo, setSignupSuccessInfo] = useState(null);

  useEffect(() => {
    setError('');
  }, [isLoginView]);

  const handleLogin = (e) => {
    e.preventDefault();
    setError('');
    const foundCounselor = approvedCounselors.find(d => d.id === counselorId);
    if (foundCounselor) {
      onLogin(foundCounselor);
    } else {
      setError('Invalid Counselor ID. Please try again.');
    }
  };
  
  const handleSignup = async (e) => {
    e.preventDefault();
    if (!counselorName.trim()) {
      setError('Please enter your full name.');
      return;
    }
    setError('');
    setIsLoading(true);

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'signup', name: counselorName.trim() }),
        mode: 'cors',
      });

      if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
      
      const responseText = await response.text();
      let newId; 
      let formattedId; 

      try {
        const result = JSON.parse(responseText);
        if (typeof result === 'object' && result !== null) {
          if (result.result !== 'success') {
            throw new Error(result.error || "An unknown error occurred during signup.");
          }
          newId = result.id ?? result.newId ?? result.counselorId ?? result.driver_id ?? result.counselor_id;
          formattedId = result.formatted_id; 
        } else if (!isNaN(parseInt(String(result), 10))) {
          newId = result;
        }
      } catch (e) {
        if (e.message.includes("Error: Driver name already exists.") || e.message.includes("Error: This name is already registered.")) {
            throw e; 
        }
        const potentialId = parseInt(responseText.trim(), 10);
        if (!isNaN(potentialId)) {
          newId = potentialId;
        }
      }

      if (newId === undefined || newId === null) {
        console.error("API response for signup is missing a valid ID.", responseText);
        if (!error) {
            throw new Error("Signup was successful, but the server did not return a Counselor ID.");
        }
      }
      
      const finalFormattedId = formattedId || formatCounselorId(newId);
      const newCounselor = { id: finalFormattedId, name: counselorName.trim() };
      
      onSignupSuccess(newCounselor); 
      setSignupSuccessInfo({ name: newCounselor.name, id: newCounselor.id }); 
      
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'An unexpected error occurred.';
      console.error("Signup failed:", err);
      setError(`Could not create ID. ${errorMessage}`);
    } finally {
      setIsLoading(false);
    }
  };

  const loginView = React.createElement('div', null,
    React.createElement('h2', { className: "text-2xl font-bold text-au-blue mb-2" }, "Peer Counselor Login"),
    React.createElement('p', { className: "text-gray-600 mb-6" }, "Enter your ID to begin."),
    React.createElement('form', { onSubmit: handleLogin },
      React.createElement('div', { className: "mb-4" },
        React.createElement('label', { htmlFor: "counselorIdInput", className: "block text-sm font-medium text-gray-700 mb-1" }, "Counselor ID"),
        React.createElement('input', { type: "text", id: "counselorIdInput", value: counselorId, onChange: (e) => setCounselorId(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark focus:border-au-blue-dark", placeholder: "e.g., PC01", required: true })
      ),
      error && React.createElement('p', { className: "text-red-600 text-sm mb-4" }, error),
      React.createElement('button', { type: "submit", className: "w-full bg-au-blue text-white font-bold py-2 px-4 rounded-md hover:bg-au-blue-dark transition-colors duration-300" }, "Login")
    ),
    React.createElement('p', { className: "text-center text-sm text-gray-600 mt-6" },
      "First time here? ",
      React.createElement('button', { onClick: () => setIsLoginView(false), className: "font-medium text-au-blue hover:underline" }, "Sign up for an ID")
    )
  );

  const signupSuccessView = React.createElement('div', null,
    React.createElement('h2', { className: "text-2xl font-bold text-green-600 mb-2" }, "Signup Successful!"),
    React.createElement('p', { className: "text-gray-600 mb-6" }, `Welcome, ${signupSuccessInfo?.name}. Your new Counselor ID is ready.`),
    React.createElement('div', { className: "bg-gray-100 p-4 rounded-lg text-center mb-6" },
        React.createElement('p', { className: "text-sm text-gray-500" }, "Your Counselor ID is:"),
        React.createElement('p', { className: "text-3xl font-bold text-au-blue tracking-widest" }, signupSuccessInfo?.id)
    ),
    React.createElement('p', { className: "text-sm text-yellow-800 bg-yellow-100 p-3 rounded-md mb-6" },
        React.createElement('span', { className: "font-bold" }, "Important:"), " Please write this ID down and keep it safe. You will need it to log in every time."
    ),
    React.createElement('button', {
        onClick: () => {
            setIsLoginView(true);
            setCounselorId(signupSuccessInfo.id); 
            setSignupSuccessInfo(null);
        },
        className: "w-full bg-au-blue text-white font-bold py-2 px-4 rounded-md hover:bg-au-blue-dark transition-colors duration-300"
    }, "Proceed to Login"),
    React.createElement('button', {
        onClick: () => {
            setIsLoginView(true);
            setCounselorId(''); 
            setSignupSuccessInfo(null);
        },
        className: "w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors duration-300 mt-3"
    }, "Login as Different User")
  );

  const signupView = React.createElement('div', null,
    React.createElement('h2', { className: "text-2xl font-bold text-au-blue mb-2" }, "First-Time Setup"),
    React.createElement('p', { className: "text-gray-600 mb-6" }, "Enter your name to get a new Counselor ID."),
    React.createElement('form', { onSubmit: handleSignup },
      React.createElement('div', { className: "mb-4" },
        React.createElement('label', { htmlFor: "counselorNameInput", className: "block text-sm font-medium text-gray-700 mb-1" }, "Your Full Name"),
        React.createElement('input', { type: "text", id: "counselorNameInput", value: counselorName, onChange: (e) => setCounselorName(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark focus:border-au-blue-dark", placeholder: "e.g., John Doe", required: true })
      ),
      error && React.createElement('p', { className: "text-red-600 text-sm mb-4" }, error),
      React.createElement('button', { type: "submit", disabled: isLoading, className: "w-full bg-au-blue text-white font-bold py-2 px-4 rounded-md hover:bg-au-blue-dark transition-colors duration-300 disabled:bg-gray-400" },
        isLoading ? 'Creating ID...' : 'Get My ID'
      )
    ),
    React.createElement('p', { className: "text-center text-sm text-gray-600 mt-6" },
      "Already have an ID? ",
      React.createElement('button', { onClick: () => setIsLoginView(true), className: "font-medium text-au-blue hover:underline" }, "Login")
    )
  );
  
  return (
    React.createElement('div', { className: "min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4" },
      React.createElement('div', { className: "flex items-center gap-3 mb-8" },
        React.createElement('div', { className: "bg-au-blue w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-2xl" }, "AU"),
        React.createElement('div', null,
          React.createElement('h1', { className: "text-3xl font-bold text-gray-900" }, "AU Wellness Watch"),
          React.createElement('p', { className: "text-sm text-gray-500" }, "CSSTHE Hackathon Project")
        )
      ),
      React.createElement('div', { className: "w-full max-w-md bg-white rounded-xl shadow-lg p-8" },
        isLoginView ? loginView : (signupSuccessInfo ? signupSuccessView : signupView)
      )
    )
  );
};


// --- START OF components/AdminLogin.tsx ---
const AdminLogin = ({ onClose, onSuccess }) => {
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (password === ADMIN_PASSWORD) {
      onSuccess();
    } else {
      setError('Incorrect password. Please try again.');
    }
  };

  return (
    React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" },
      React.createElement('div', { className: "bg-white rounded-xl shadow-2xl w-full max-w-sm m-4" },
        React.createElement('div', { className: "p-6" },
          React.createElement('h2', { className: "text-xl font-bold text-au-blue mb-2" }, "Admin Access"),
          React.createElement('p', { className: "text-gray-600 mb-6" }, "Enter the password to view the dashboard."),
          React.createElement('form', { onSubmit: handleSubmit },
            React.createElement('div', { className: "mb-4" },
              React.createElement('label', { htmlFor: "adminPassword", className: "block text-sm font-medium text-gray-700 mb-1" }, "Password"),
              React.createElement('input', { id: "adminPassword", type: "password", value: password, onChange: (e) => setPassword(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark focus:border-au-blue-dark", required: true, autoFocus: true })
            ),
            error && React.createElement('p', { className: "text-red-500 text-sm mb-4" }, error),
            React.createElement('div', { className: "flex justify-end gap-3 mt-6" },
              React.createElement('button', { type: "button", onClick: onClose, className: "px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 transition-colors" }, "Cancel"),
              React.createElement('button', { type: "submit", className: "px-4 py-2 text-sm font-medium text-white bg-au-blue rounded-md hover:bg-au-blue-dark transition-colors" }, "Access Dashboard")
            )
          )
        )
      )
    )
  );
};

// --- START OF components/DriverPortal.tsx ---
const ClientForm = ({ onSubmit }) => {
  const [concernCategory, setConcernCategory] = useState('');
  const [specificConcern, setSpecificConcern] = useState('');
  const [suicideStage, setSuicideStage] = useState('');
  const [area, setArea] = useState('');
  const [college, setCollege] = useState('');
  const [gender, setGender] = useState('Unknown / Not Specified');
  const [age, setAge] = useState('');
  const [yearOfStudy, setYearOfStudy] = useState('Unknown');
  const [marital, setMarital] = useState('Unknown');

  const isSuicideRisk = concernCategory === 'Thoughts of self-harm';

  const resetForm = () => {
    setConcernCategory('');
    setSpecificConcern('');
    setSuicideStage('');
    setArea('');
    setCollege('');
    setGender('Unknown / Not Specified');
    setAge('');
    setYearOfStudy('Unknown');
    setMarital('Unknown');
  };
  
  const handleSubmit = (e) => {
    e.preventDefault();
    
    const entrySuicideStage = isSuicideRisk ? (suicideStage || '') : ''; 
    const entryConcern = isSuicideRisk ? "Thoughts of self-harm" : `${concernCategory} - ${specificConcern}`;

    const newEntry = {
      timestamp: new Date().toISOString(),
      area,
      college,
      gender,
      age: parseInt(age) || 0,
      yearOfStudy,
      marital,
      concern: entryConcern,
      suicideStage: entrySuicideStage,
    };
    onSubmit(newEntry);
    resetForm();
  };

  return (
    React.createElement('div', { className: "bg-white p-6 md:p-8 rounded-xl shadow-lg" },
      React.createElement('div', { className: "mb-6 pb-4 border-b border-gray-200" },
        React.createElement('h2', { className: "text-2xl font-bold text-au-blue" }, "Log Anonymous Student Concern"),
        React.createElement('p', { className: "text-gray-500 mt-1" }, "All data is 100% anonymous to protect student privacy.")
      ),
      React.createElement('form', { onSubmit: handleSubmit, className: "space-y-6" },
        React.createElement('div', null,
          React.createElement('label', { htmlFor: "concernCategory", className: "block text-sm font-medium text-gray-700 mb-1" }, "Primary Concern Category *"),
          React.createElement('select', { id: "concernCategory", value: concernCategory, onChange: e => setConcernCategory(e.target.value), required: true, className: "w-full px-3 py-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark focus:border-au-blue-dark border-2" },
            React.createElement('option', { value: "" }, "Select a Category..."),
            CONCERN_CATEGORIES.map(c => React.createElement('option', { key: c, value: c }, c.replace(/ *\\([^)]*\\) */g, "")))
          )
        ),
        
        !isSuicideRisk && concernCategory && (
            React.createElement('div', null,
                React.createElement('label', { htmlFor: "specificConcernInput", className: "block text-sm font-medium text-gray-700 mb-1" }, "Specific Concern (Optional)"),
                React.createElement('input', { type: "text", id: "specificConcernInput", value: specificConcern, onChange: e => setSpecificConcern(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark", placeholder: "Briefly describe the issue..." })
            )
        ),

        isSuicideRisk && (
            React.createElement('div', { className: "bg-yellow-50 border border-yellow-300 p-4 rounded-md" },
                React.createElement('label', { htmlFor: "suicideStage", className: "block text-sm font-bold text-yellow-800 mb-1" }, "Suicide Risk Level *"),
                React.createElement('select', { id: "suicideStage", value: suicideStage, onChange: e => setSuicideStage(e.target.value), required: true, className: "w-full px-3 py-2 border-yellow-400 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" },
                    React.createElement('option', { value: "" }, "Select Stage..."),
                    SUICIDE_STAGES.map(s => React.createElement('option', { key: s, value: s }, s))
                )
            )
        ),

        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
          // --- FORM PRIORITY CHANGE: College is now first and required ---
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "college", className: "block text-sm font-medium text-gray-700 mb-1" }, "College / Faculty *"),
            React.createElement('select', { id: "college", value: college, onChange: e => setCollege(e.target.value), required: true, className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" },
              React.createElement('option', { value: "" }, "Select College..."),
              COLLEGES.map(c => React.createElement('option', { key: c, value: c }, c))
            )
          ),
          // --- FORM PRIORITY CHANGE: Location is now second and optional ---
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "area", className: "block text-sm font-medium text-gray-700 mb-1" }, "Location of Conversation (Optional)"),
            React.createElement('select', { id: "area", value: area, onChange: e => setArea(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" },
              React.createElement('option', { value: "" }, "Select Location"),
              CAMPUS_LOCATIONS.map(a => React.createElement('option', { key: a, value: a }, a))
            )
          ),
           React.createElement('div', null,
            React.createElement('label', { htmlFor: "gender", className: "block text-sm font-medium text-gray-700 mb-1" }, "Student Gender (Optional)"),
            React.createElement('select', { id: "gender", value: gender, onChange: e => setGender(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" },
              GENDERS.map(g => React.createElement('option', { key: g, value: g }, g))
            )
          ),
           React.createElement('div', null,
            React.createElement('label', { htmlFor: "age", className: "block text-sm font-medium text-gray-700 mb-1" }, "Student Age"),
            React.createElement('input', { type: "number", id: "age", value: age, onChange: e => setAge(e.target.value), min: "15", max: "50", className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" })
          ),
           React.createElement('div', null,
            React.createElement('label', { htmlFor: "yearOfStudy", className: "block text-sm font-medium text-gray-700 mb-1" }, "Student Year of Study (Optional)"),
            React.createElement('select', { id: "yearOfStudy", value: yearOfStudy, onChange: e => setYearOfStudy(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" },
              YEAR_OF_STUDY.map(s => React.createElement('option', { key: s, value: s }, s))
            )
          ),
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "marital", className: "block text-sm font-medium text-gray-700 mb-1" }, "Student Marital Status (Optional)"),
            React.createElement('select', { id: "marital", value: marital, onChange: e => setMarital(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-au-blue-dark" },
              MARITAL_STATUSES.map(s => React.createElement('option', { key: s, value: s }, s))
            )
          )
        ),
        
        React.createElement('div', null,
          React.createElement('button', { type: "submit", className: "w-full md:w-auto bg-au-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-au-blue-dark transition-colors duration-300" },
            "Submit Anonymous Report"
          )
        )
      )
    )
  );
};

const CounselorPortal = ({ counselor, allClientData, onSubmit }) => {
  const counselorData = useMemo(() => {
    // --- THIS IS THE FIX for "0 Reports" bug ---
    // Your "previous" code.gs sends 'counselor', not 'name'.
    // This code now correctly looks for 'counselor'.
    return allClientData.filter(e => e.counselor === counselor.name);
  }, [allClientData, counselor.name]);

  const stats = useMemo(() => {
    const now = new Date();
    const todayStart = new Date(now.setHours(0, 0, 0, 0));
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    const todayCount = counselorData.filter(e => new Date(e.timestamp) >= todayStart).length;
    const weekCount = counselorData.filter(e => new Date(e.timestamp) >= weekAgo).length;

    return {
      total: counselorData.length,
      today: todayCount,
      week: weekCount,
    };
  }, [counselorData]);

  const recentEntries = useMemo(() => {
    // Sort by date to get most recent
    return counselorData
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 5);
  }, [counselorData]);

  return (
    React.createElement('div', { className: "space-y-8" },
      React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
        React.createElement(StatCard, { label: "Today's Reports by You", value: stats.today }),
        React.createElement(StatCard, { label: "This Week by You", value: stats.week }),
        React.createElement(StatCard, { label: "Total Reports by You", value: stats.total, color: "#28A745", size: "large" })
      ),
      React.createElement(ClientForm, { onSubmit }),
      React.createElement('div', { className: "bg-white p-6 md:p-8 rounded-xl shadow-lg" },
        React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, "Your 5 Most Recent Reports"),
        recentEntries.length > 0 ? (
          React.createElement('div', { className: "space-y-3" },
            recentEntries.map((entry, index) => {
              // Fix for crash if client_id is missing
              const clientId = entry.client_id ? entry.client_id.toString() : `pending-${index}`;
              const isOffline = clientId.startsWith('offline-') || clientId.startsWith('pending-');

              return React.createElement('div', { key: clientId, className: "p-4 bg-gray-50 rounded-lg flex justify-between items-center" },
                React.createElement('div', null,
                  React.createElement('p', { className: "font-semibold text-gray-700" }, `Report #${clientId}`),
                  React.createElement('p', { className: "text-sm text-gray-500" }, new Date(entry.timestamp).toLocaleString())
                ),
                React.createElement('span', { className: `text-xs font-medium px-2 py-0.5 rounded-full ${isOffline ? 'text-yellow-700 bg-yellow-100' : 'text-green-700 bg-green-100'}` }, 
                  isOffline ? 'Pending Sync' : 'Synced'
                )
              )
            })
          )
        ) : (
          React.createElement('p', { className: "text-gray-500" }, "You haven't submitted any reports recently.")
        )
      )
    )
  );
};

// --- START OF components/Dashboard.tsx ---
const DataChart = ({ data, dataKey, nameKey, title }) => {
  const chartData = useMemo(() => {
    const counts = data.reduce((acc, entry) => {
      let key = entry[dataKey];
      if (dataKey === 'concern') {
        key = (key || 'Other').split(' - ')[0];
      }
      if (key) {
        acc[key] = (acc[key] || 0) + 1;
      }
      return acc;
    }, {});
    return Object.entries(counts)
      .map(([name, value]) => ({ name, [nameKey]: value }))
      .sort((a, b) => b[nameKey] - a[nameKey]);
  }, [data, dataKey, nameKey]);

  return (
    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
      React.createElement('h3', { className: "text-lg font-semibold text-gray-800 mb-4" }, title),
      chartData.length > 0 ? (
        React.createElement(ResponsiveContainer, { width: "100%", height: 300 },
          React.createElement(BarChart, { data: chartData, layout: "vertical", margin: { left: 100 } },
            React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "#e0e0e0" }),
            React.createElement(XAxis, { type: "number", stroke: "#9e9e9e" }),
            React.createElement(YAxis, { type: "category", dataKey: "name", width: 100, stroke: "#9e9e9e", interval: 0, fontSize: 12 }),
            React.createElement(Tooltip, { formatter: (value) => [value, 'Reports'] }),
            React.createElement(Bar, { dataKey: nameKey, fill: "#004a99" })
          )
        )
      ) : (
        React.createElement('p', { className: "text-gray-500" }, "No data to display.")
      )
    )
  );
};

const SuicideWatchList = ({ data }) => {
  const watchList = useMemo(() => {
    return data.filter(c => 
      (c.suicideStage && c.suicideStage !== 'N/A' && c.suicideStage !== '') || 
      (c.concern && c.concern.includes("Thoughts of self-harm"))
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  }, [data]);

  return (
    React.createElement('div', { className: "bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow-lg overflow-hidden" },
      React.createElement('details', { open: true },
        React.createElement('summary', { className: "p-6 cursor-pointer flex justify-between items-center" },
          React.createElement('h2', { className: "text-2xl font-bold text-yellow-800" }, "High-Risk Student Reports"),
          React.createElement('span', { className: "text-2xl font-bold text-white bg-yellow-600 rounded-full w-10 h-10 flex items-center justify-center" }, watchList.length)
        ),
        React.createElement('div', { className: "p-6 pt-0" },
          watchList.length > 0 ? (
            React.createElement('div', { className: "overflow-x-auto" },
              React.createElement('table', { className: "min-w-full divide-y divide-yellow-200" },
                React.createElement('thead', { className: "bg-yellow-100" },
                  React.createElement('tr', null,
                    React.createElement('th', { scope: "col", className: "px-4 py-3 text-left text-xs font-bold text-yellow-700 uppercase tracking-wider" }, "Report ID"),
                    React.createElement('th', { scope: "col", className: "px-4 py-3 text-left text-xs font-bold text-yellow-700 uppercase tracking-wider" }, "Counselor"),
                    React.createElement('th', { scope: "col", className: "px-4 py-3 text-left text-xs font-bold text-yellow-700 uppercase tracking-wider" }, "Date"),
                    React.createElement('th', { scope: "col", className: "px-4 py-3 text-left text-xs font-bold text-yellow-700 uppercase tracking-wider" }, "Risk Level")
                  )
                ),
                React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                  watchList.map(client => (
                    React.createElement('tr', { key: client.client_id },
                      React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.client_id),
                      React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.counselor), // Use client.counselor
                      React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, new Date(client.timestamp).toLocaleDateString()),
                      React.createElement('td', { className: "px-4 py-3 text-sm font-semibold text-au-blue" }, client.suicideStage || 'High Risk')
                    )
                  ))
                )
              )
            )
          ) : (
            React.createElement('p', {className: "text-gray-600"}, "No high-risk reports found in the system.")
          )
        )
      )
    )
  );
};

const AllDataTable = ({ data, onExport }) => {
  return (
    React.createElement('div', { className: "bg-white p-6 md:p-8 rounded-xl shadow-lg" },
      React.createElement('div', { className: "flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "All Anonymous Data"),
        React.createElement('button', { onClick: onExport, className: "bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300" }, "Export to CSV")
      ),
      React.createElement('div', { className: "overflow-x-auto" },
        React.createElement('table', { className: "min-w-full divide-y divide-gray-200" },
          React.createElement('thead', { className: "bg-gray-50" },
            React.createElement('tr', null,
              ['ID', 'Counselor', 'Date/Time', 'Location', 'Gender', 'Age', 'Year', 'Marital', 'Category', 'Specifics', 'Risk Stage'].map(h => (
                React.createElement('th', { key: h, scope: "col", className: "px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider" }, h)
              ))
            )
          ),
          React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
            data.length > 0 ? (
              data.map(client => {
                const [category, specific] = (client.concern || ' - ').split(' - ');
                return (
                  React.createElement('tr', { key: client.client_id },
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.client_id),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.counselor), // Use client.counselor
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, new Date(client.timestamp).toLocaleString()),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.area),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.gender),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.age > 0 ? client.age : 'N/A'),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.yearOfStudy),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, client.marital),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, category),
                    React.createElement('td', { className: "px-4 py-3 text-sm text-gray-700" }, specific),
                    React.createElement('td', { className: "px-4 py-3 text-sm font-semibold text-au-blue" }, client.suicideStage || 'N/A')
                  )
                );
              })
            ) : (
              React.createElement('tr', null,
                React.createElement('td', { colSpan: 11, className: "px-4 py-4 text-center text-gray-500" }, "No data available")
              )
            )
          )
        )
      )
    )
  );
};

const Dashboard = ({ allClientData, onExport }) => {
  const [insights, setInsights] = useState("Generating AI insights... please wait.");
  const [isLoadingInsights, setIsLoadingInsights] = useState(false);

  const getInsights = useCallback(async () => {
      if (allClientData.length > 0) {
          setIsLoadingInsights(true);
          try {
              const result = await generateInsights(allClientData);
              const formattedResult = result
                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                  .replace(/(\n|^)#{1,3} (.*?)(?=\n|$)/g, '$1<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$2</h3>')
                  .replace(/\n/g, '<br />');
              setInsights(formattedResult);
          } catch (error) {
              setInsights("An error occurred while generating insights.");
          } finally {
              setIsLoadingInsights(false);
          }
      } else {
          setInsights("Not enough data to generate insights.");
      }
  }, [allClientData]);

  const dashboardStats = useMemo(() => {
    if (allClientData.length === 0) {
      return { total: 0, avgAge: 'N/A', topCollege: 'N/A' };
    }
    const validAges = allClientData.map(c => c.age).filter(age => age > 0);
    const totalAge = validAges.reduce((sum, age) => sum + age, 0);
    const avgAge = validAges.length > 0 ? Math.round(totalAge / validAges.length) : 'N/A';
    
    // --- DASHBOARD CHANGE: Track College instead of Area ---
    const collegeCounts = allClientData.reduce((acc, c) => {
      if (c.college) acc[c.college] = (acc[c.college] || 0) + 1;
      return acc;
    }, {});
    const topCollege = Object.keys(collegeCounts).length > 0 ? Object.entries(collegeCounts).sort((a,b) => b[1]-a[1])[0][0] : 'N/A';

    return {
      total: allClientData.length,
      avgAge,
      topCollege, // Use topCollege
    };
  }, [allClientData]);

  return (
    React.createElement('div', { className: "space-y-8" },
      React.createElement(SuicideWatchList, { data: allClientData }),
      React.createElement('div', { className: "bg-white rounded-xl shadow-lg overflow-hidden" },
        React.createElement('details', { open: true },
          React.createElement('summary', { className: "p-6 cursor-pointer flex justify-between items-center" },
            React.createElement('h2', { className: "text-2xl font-bold text-au-blue" }, "AI-Powered Insights"),
            React.createElement('button', { 
                onClick: (e) => { 
                    e.preventDefault(); 
                    getInsights(); 
                }, 
                disabled: isLoadingInsights,
                className: "bg-au-blue text-white font-semibold py-2 px-5 rounded-lg hover:bg-au-blue-dark transition-colors duration-300 disabled:bg-gray-400" 
            }, isLoadingInsights ? 'Generating...' : 'Regenerate')
          ),
          React.createElement('div', { className: "p-6 pt-0" },
            React.createElement('div', { 
                className: "text-gray-700 space-y-2 prose",
                dangerouslySetInnerHTML: { __html: insights }
            })
          )
        )
      ),
      React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
        React.createElement(StatCard, { label: "Total Anonymous Reports", value: dashboardStats.total, size: "large" }),
        React.createElement(StatCard, { label: "Average Age (Est.)", value: dashboardStats.avgAge }),
        // --- DASHBOARD CHANGE: Show Top College ---
        React.createElement(StatCard, { label: "Top College by Reports", value: dashboardStats.topCollege, color: "#6C757D" })
      ),
      React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-6" },
        React.createElement(DataChart, { data: allClientData, dataKey: "concern", nameKey: "Reports", title: "Primary Concerns Distribution" }),
        // --- DASHBOARD CHANGE: Show College Chart ---
        React.createElement(DataChart, { data: allClientData, dataKey: "college", nameKey: "Reports", title: "College Distribution" })
      ),
      React.createElement(AllDataTable, { data: allClientData, onExport: onExport })
    )
  );
};

// --- START OF App.tsx ---
const App = () => {
  const [allClientData, setAllClientData] = useState([]);
  const [approvedCounselors, setApprovedCounselors] = useState([]);
  const [counselor, setCounselor] = useLocalStorage('au-wellness-counselor', null);
  const [offlineQueue, setOfflineQueue] = useLocalStorage('au-wellness-offlineQueue', []);
  
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [isSyncing, setIsSyncing] = useState(false);
  const [isLoadingData, setIsLoadingData] = useState(true);
  
  const [currentPage, setCurrentPage] = useState('counselor');
  const [isAuthError, setIsAuthError] = useState(false);
  const [authError, setAuthError] = useState(null);
  const [isShowingAdminLogin, setIsShowingAdminLogin] = useState(false);
  const [isShowingSuccess, setIsShowingSuccess] = useState(false);

  // --- Network & Sync Logic ---
  const updateNetworkStatus = useCallback(() => {
    setIsOnline(navigator.onLine);
  }, []);
  
  const fetchData = useCallback(async (currentCounselor, currentOfflineQueue) => {
    const counselorToUse = counselor || currentCounselor;
    if (!counselorToUse) return;
    
    const queue = currentOfflineQueue !== undefined ? currentOfflineQueue : offlineQueue;
    
    console.log("Fetching all client data...");
    setIsLoadingData(true);
    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'load' }),
        mode: 'cors',
      });
      
      if (!response.ok) {
          if (response.status === 404) throw new Error("URL not found. Check SCRIPT_URL.");
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const responseText = await response.text();
      let data;
      try {
        if (typeof responseText !== 'string' || responseText.length === 0 || responseText === "undefined") {
          throw new Error("Empty or invalid response from server");
        }
        data = JSON.parse(responseText);
      } catch (e) {
        console.error("Failed to parse JSON response:", responseText);
        const errorText = String(responseText || "empty response");
        throw new Error(`Server returned invalid data: ${errorText.substring(0, 100)}... (Original: ${e.message})`);
      }

      if (data.result !== 'success') {
        throw new Error(data.error || 'Failed to load data from server.');
      }
      
      const serverData = data.clients || [];
      const counselorData = data.drivers || [];
      
      const formattedCounselors = counselorData.map(c => ({ ...c, id: formatCounselorId(c.id) }));
      setApprovedCounselors(formattedCounselors);

      const offlineIds = new Set(queue.map(e => e.timestamp));
      const filteredServerData = serverData.filter(e => !offlineIds.has(e.timestamp));
      
      const localData = queue.map((entry, index) => ({
          ...entry,
          client_id: `offline-${queue.length - index}`,
          counselor: counselorToUse.name, // Add counselor name
      }));

      const combinedData = [...localData, ...filteredServerData];
      
      setAllClientData(combinedData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));

    } catch (error) {
      console.error('Error loading data from Google Sheets:', error);
      const localData = queue.map((entry, index) => ({
          ...entry,
          client_id: `offline-${queue.length - index}`,
          counselor: counselorToUse.name, // Add counselor name
      }));
      setAllClientData(localData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
      
    } finally {
      setIsLoadingData(false);
    }
  }, [counselor, offlineQueue]);
  
  const syncOfflineQueue = useCallback(async () => {
    if (!isOnline || isSyncing || offlineQueue.length === 0) {
      return;
    }
    
    console.log(`Syncing ${offlineQueue.length} entries...`);
    setIsSyncing(true);
    
    const currentCounselor = counselor || getValueFromStorage('au-wellness-counselor', null);
    
    if (!currentCounselor) {
      console.warn("Cannot sync, no counselor data available.");
      setIsSyncing(false);
      return;
    }
    
    let successfulTimestamps = [];
    const queueToProcess = [...offlineQueue];

    for (const entry of queueToProcess.reverse()) {
        const entryWithCounselor = {
            ...entry,
            counselor: currentCounselor.name, // Use 'counselor' to match backend sheet
            client_id: `pwa-${Date.now()}-${Math.floor(Math.random() * 999)}`
        };

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ 
                    action: 'addClient', 
                    data: entryWithCounselor
                }),
                mode: 'cors',
            });

            if (!response.ok) throw new Error(`Server sync failed with status: ${response.status}`);
            
            const responseData = await response.json();
            if (responseData.result !== 'success') {
                throw new Error(responseData.error || 'Sync failed with unknown server error.');
            }
            
            successfulTimestamps.push(entry.timestamp);
            
        } catch (error) {
            console.error('Sync failed for one entry:', error);
        }
    }
    
    console.log(`Sync complete: ${successfulTimestamps.length} successful.`);
    
    const newOfflineQueue = queueToProcess.filter(entry => 
        !successfulTimestamps.includes(entry.timestamp)
    );
    setOfflineQueue(newOfflineQueue);
    
    setIsSyncing(false);
    fetchData(currentCounselor, newOfflineQueue);

  }, [isOnline, isSyncing, offlineQueue, setOfflineQueue, counselor, fetchData]);

  useEffect(() => {
    window.addEventListener('online', updateNetworkStatus);
    window.removeEventListener('offline', updateNetworkStatus);
    return () => {
      window.removeEventListener('online', updateNetworkStatus);
      window.removeEventListener('offline', updateNetworkStatus);
    };
  }, [updateNetworkStatus]);

  useEffect(() => {
    if (isOnline && counselor) {
      syncOfflineQueue();
    }
  }, [isOnline, counselor, syncOfflineQueue]);
 
  useEffect(() => {
    if (counselor) {
      fetchData(counselor, offlineQueue);
    } else {
      (async () => {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'load' }),
                mode: 'cors',
            });
            if (!response.ok) {
                 if (response.status === 404) throw new Error("URL not found. Check SCRIPT_URL.");
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const responseText = await response.text();
            let data;
            try {
              if (typeof responseText !== 'string' || responseText.length === 0 || responseText === "undefined") {
                throw new Error("Empty or invalid response from server");
              }
              data = JSON.parse(responseText);
            } catch (e) {
              console.error("Failed to parse JSON response:", responseText);
              const errorText = String(responseText || "empty response");
              if (responseText === "undefined") {
                  throw new Error('"undefined" is not valid JSON');
              }
              throw new Error(`Server returned invalid data: ${errorText.substring(0, 100)}... (Original: ${e.message})`);
            }

            if (data.result !== 'success') throw new Error(data.error || 'Failed to load data.');

            const counselorData = data.drivers || [];
            const formattedCounselors = counselorData.map(c => ({ ...c, id: formatCounselorId(c.id) }));
            setApprovedCounselors(formattedCounselors);

        } catch (error) {
            console.error("Could not load counselors list for login:", error);
            setAuthError(error.message || 'An unknown error occurred.');
            setIsAuthError(true);
        }
      })();
    }
  }, [counselor, fetchData, offlineQueue]);

  // --- Event Handlers ---
  const handleLogin = (loggedInCounselor) => {
    setCounselor(loggedInCounselor);
    setCurrentPage('counselor');
  };
  
  const handleSignupSuccess = (newCounselor) => {
    setApprovedCounselors(prev => [...prev, newCounselor]);
  };

  const handleLogout = () => {
    setCounselor(null);
    setCurrentPage('counselor');
    setAllClientData([]);
  };

  const handleFormSubmit = (newEntry) => {
    const newOfflineQueue = [newEntry, ...offlineQueue];
    setOfflineQueue(newOfflineQueue);
    
    setAllClientData(prevData => {
        const optimisticEntry = {
            ...newEntry,
            client_id: `offline-${newOfflineQueue.length}`,
            counselor: counselor.name, // Add 'counselor' to optimistic entry
        };
        const newData = [optimisticEntry, ...prevData];
        return newData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    });
    
    setIsShowingSuccess(true);
    setTimeout(() => setIsShowingSuccess(false), 3000);
    
    // --- WHATSAPP TRIGGER REMOVED ---
    // The backend (code.gs) is now responsible for this.
    // --- END ---
    
    setTimeout(() => {
        syncOfflineQueue();
    }, 100);
  };

  const handleAdminClick = () => {
    setIsShowingAdminLogin(true);
  };

  const handleAdminSuccess = () => {
    setIsShowingAdminLogin(false);
    setCurrentPage('dashboard');
  };

  const exportToCSV = () => {
    if (allClientData.length === 0) {
        alert('No data to export.');
        return;
    }
    const headers = [ "ID", "Counselor", "Date", "Time", "Location", "College", "Gender", "Age", "Year of Study", "Marital Status", "Concern Category", "Specific Concern", "Suicide Stage" ];
    let csvContent = headers.join(",") + "\r\n";
    
    const sortedData = [...allClientData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    sortedData.forEach(client => {
        const timestamp = new Date(client.timestamp);
        const [concernCategory, specificProblem] = (client.concern || ' - ').split(' - ');
        const row = [ 
            client.client_id, 
            client.counselor, // Use client.counselor
            timestamp.toLocaleDateString(), 
            timestamp.toLocaleTimeString(), 
            client.area,
            client.college,
            client.gender, 
            client.age > 0 ? client.age : '', 
            client.yearOfStudy, 
            client.marital, 
            concernCategory, 
            (specificProblem || ''), 
            (client.suicideStage || '') 
        ];
        const sanitizedRow = row.map(field => `"${String(field || '').replace(/"/g, '""')}"`);
        csvContent += sanitizedRow.join(",") + "\r\n";
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    const fileName = `au-wellness-report-${new Date().toISOString().split('T')[0]}.csv`;
    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
  
  // --- Render Logic ---
  if (isAuthError) {
    const isSheetError = authError && (authError.includes("getSheetByName") || authError.includes("openById"));
    const isInvalidDataError = authError && (authError.includes("Server returned invalid data") || authError.includes("is not valid JSON") || authError.includes("URL is not valid"));

    return (
      React.createElement('div', { className: "min-h-screen bg-gray-100 flex items-center justify-center p-4" },
        React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-lg max-w-2xl" },
          React.createElement('h2', { className: "text-2xl font-bold text-red-600 mb-4" }, "Application Error"),
          isSheetError ? (
            React.createElement('div', { className: "text-left space-y-3 text-gray-700" },
              React.createElement('p', { className: "font-semibold" }, "A backend configuration error was detected:"),
              React.createElement('p', { className: "text-sm bg-gray-100 p-3 rounded-md font-mono" }, authError),
              React.createElement('p', null, "This specific error means your Google Apps Script is not correctly linked to your Google Sheet. This is not an app bug, but a setup issue."),
              React.createElement('h3', { className: "text-lg font-bold text-au-blue pt-3" }, "How to Fix (in Google Sheets):"),
              React.createElement('ol', { className: "list-decimal list-inside space-y-2" },
                React.createElement('li', null, "Go to your Google Sheet (with 'Counselors' and 'Clients' tabs)."),
                React.createElement('li', null, "Click ", React.createElement('strong', null, "Extensions > Apps Script"), " at the top."),
                React.createElement('li', null, "Paste the ", React.createElement('code', { className: "text-sm" }, "code.gs"), " content I provided into this new script editor."),
                React.createElement('li', null, "Ensure the ", React.createElement('code', { className: "text-sm" }, "SPREADSHEET_ID"), " in ", React.createElement('code', { className: "text-sm" }, "code.gs"), " is correct."),
                React.createElement('li', null, "Click ", React.createElement('strong', null, "Deploy > New deployment"), ". Set 'Who has access' to ", React.createElement('strong', null, "Anyone"), " and deploy."),
                React.createElement('li', null, "Copy the new 'Web app URL' it gives you."),
                React.createElement('li', null, "Paste that new URL into the ", React.createElement('code', { className: "text-sm" }, "SCRIPT_URL"), " constant (line 120) in this ", React.createElement('code', { className: "text-sm" }, "index.html"), " file.")
              )
            )
          ) : isInvalidDataError ? (
             React.createElement('div', { className: "text-left space-y-3 text-gray-700" },
              React.createElement('p', { className: "font-semibold" }, "A backend data error was detected:"),
              React.createElement('p', { className: "text-sm bg-gray-100 p-3 rounded-md font-mono" }, authError),
              React.createElement('p', null, "This means the app received an unexpected response from the Google Apps Script backend. This often happens if the script is not deployed correctly, has an internal error, or the URL is wrong."),
              React.createElement('h3', { className: "text-lg font-bold text-au-blue pt-3" }, "How to Fix (in Google Apps Script):"),
              React.createElement('ol', { className: "list-decimal list-inside space-y-2" },
                React.createElement('li', null, "Check the ", React.createElement('code', {className: "text-sm"}, "SCRIPT_URL"), " in ", React.createElement('code', {className: "text-sm"}, "index.html"), " (line 120) to ensure it's correct."),
                React.createElement('li', null, "Open your Apps Script project."),
                React.createElement('li', null, "Click ", React.createElement('strong', null, "Deploy > Manage deployments"), "."),
                React.createElement('li', null, "Click the ", React.createElement('strong', null, "pencil icon (Edit)"), "."),
                React.createElement('li', null, "Change 'Version' to ", React.createElement('strong', null, "'New version'"), "."),
                React.createElement('li', null, "Click ", React.createElement('strong', null, "Deploy"), ". This ensures your latest code is live."),
                React.createElement('li', null, "If it still fails, check the script for errors and ensure your Sheet ID is correct.")
              )
            )
          ) : (
            React.createElement('div', { className: "text-center" },
                React.createElement('p', { className: "text-gray-700" }, "Could not connect to the server to load initial data. Please check your internet connection and refresh the page."),
                React.createElement('p', { className: "text-sm bg-gray-100 p-3 rounded-md mt-4 font-mono" }, `Error: ${authError || 'Unknown error'}`)
            )
          )
        )
      )
    );
  }

  if (!counselor) {
    return React.createElement(CounselorSetup, { approvedCounselors, onLogin: handleLogin, onSignupSuccess: handleSignupSuccess });
  }

  return (
    React.createElement('div', { className: "min-h-screen bg-gray-100" },
      React.createElement(Header, {
        counselor,
        onLogout: handleLogout,
        isOnline,
        syncing: isSyncing,
        queueLength: offlineQueue.length,
        currentPage,
        onNavigate: setCurrentPage,
        onAdminClick: handleAdminClick,
        isLoadingData
      }),
      React.createElement('main', { className: "container mx-auto p-4 sm:p-6 lg:p-8" },
        React.createElement('div', { style: { display: currentPage === 'counselor' ? 'block' : 'none' } },
          React.createElement(CounselorPortal, { counselor, allClientData, onSubmit: handleFormSubmit })
        ),
        React.createElement('div', { style: { display: currentPage === 'dashboard' ? 'block' : 'none' } },
          React.createElement(Dashboard, { allClientData, onExport: exportToCSV })
        )
      ),
      isShowingAdminLogin && React.createElement(AdminLogin, {
        onClose: () => setIsShowingAdminLogin(false),
        onSuccess: handleAdminSuccess
      }),
      isShowingSuccess && (
        React.createElement('div', { className: "fixed bottom-6 right-6 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg animate-pulse" },
          "Report submitted successfully!"
        )
      )
    )
  );
};


// --- START OF index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Failed to find the root element");
}
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(React.StrictMode, null, React.createElement(App, null)));

    </script>
</body>
</html>